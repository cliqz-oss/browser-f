(function(a){function b(d){if(c[d])return c[d].exports;var e=c[d]={exports:{},id:d,loaded:!1};return a[d].call(e.exports,e,e.exports,b),e.loaded=!0,e.exports}var c={};return b.m=a,b.c=c,b.p="",b(0)})([function(a,b,c){"use strict";Object.defineProperty(b,"__esModule",{value:!0});var d=Object.assign||function(k){for(var m,l=1;l<arguments.length;l++)for(var n in m=arguments[l],m)Object.prototype.hasOwnProperty.call(m,n)&&(k[n]=m[n]);return k},e=c(1);const g=24*(3600*1e3);class j extends e.Action{constructor(k,l){super(k,l),this.storage=k.createStorage(l.id),this.heartbeatStorage=k.createStorage("normandy-heartbeat"),this.updateLastInteraction=this.updateLastInteraction.bind(this),this.updateLastShown=this.updateLastShown.bind(this)}generateSurveyId(){var k=this.recipe.arguments;const l=k.includeTelemetryUUID,m=k.surveyId,n=this.normandy.userId;let o=m;return l&&!!n&&(o=`${m}::${n}`),o}async heartbeatShownRecently(){const k=await this.heartbeatStorage.getItem("lastShown"),l=k?new Date-parseFloat(k):Infinity;return l<g}async getLastShown(){const k=await this.storage.getItem("lastShown");return"undefined"==typeof k?null:parseFloat(k)}async hasShownBefore(){return null!==(await this.storage.getItem("lastShown"))}async shownAtleastDaysAgo(k){const l=await this.hasShownBefore();if(!l)return!1;const m=await this.getLastShown(),n=Date.now()-m;return n<g*k}async getLastInteraction(){const k=await this.storage.getItem("lastInteraction");return"undefined"==typeof k?null:parseFloat(k)}async sinceLastInteraction(){const k=await this.getLastInteraction();return"undefined"==typeof k?null:Date.now()-k}async hasHadInteraction(){const k=await this.getLastInteraction();return!!k}async heartbeatHasExecuted(){let k=!1;var l=this.recipe.arguments;const m=l.repeatOption,n=l.repeatEvery;switch(m){default:case"once":k=await this.hasShownBefore();break;case"nag":k=await this.hasHadInteraction();break;case"xdays":k=await this.shownAtleastDaysAgo(n);}return k}async shouldNotExecute(){return!this.normandy.testing&&((await this.heartbeatShownRecently())||(await this.heartbeatHasExecuted()))}async execute(){var k=this.recipe.arguments;const l=k.message,m=k.engagementButtonLabel,n=k.thanksMessage,o=k.postAnswerUrl,p=k.learnMoreMessage,q=k.learnMoreUrl;if(await this.shouldNotExecute())return;this.client=await this.normandy.client();const r=this.normandy.userId,s=this.generateSurveyId(),t={surveyId:s,message:l,engagementButtonLabel:m,thanksMessage:n,learnMoreMessage:p,learnMoreUrl:q,postAnswerUrl:this.generatePostURL(o,r),flowId:this.normandy.uuid(),surveyVersion:this.recipe.revision_id};this.normandy.testing&&(t.testing=1);const u=await this.normandy.showHeartbeat(t);["Voted","Engaged"].forEach((w)=>{u.on(w,this.updateLastInteraction)}),this.updateLastShown()}updateLastShown(){this.storage.setItem("lastShown",Date.now()),this.heartbeatStorage.setItem("lastShown",Date.now())}updateLastInteraction(){this.storage.setItem("lastInteraction",Date.now())}getGAParams(){let k=this.recipe.arguments.message||"";k=k.replace(/\s+/g,""),k=encodeURIComponent(k);const l=new URL("http://mozilla.com");return l.searchParams.set("message",k),k=l.search.replace("?message=",""),{utm_source:"firefox",utm_medium:this.recipe.action,utm_campaign:k}}generatePostURL(k,l){if(!k)return k;const m=d({source:"heartbeat",surveyversion:56,updateChannel:this.client.channel,fxVersion:this.client.version,isDefaultBrowser:this.client.isDefaultBrowser?1:0,searchEngine:this.client.searchEngine,syncSetup:this.client.syncSetup?1:0},this.getGAParams());this.recipe.arguments.includeTelemetryUUID&&l&&(m.userId=l),this.normandy.testing&&(m.testing=1);const n=new URL(k);for(const o in m)m.hasOwnProperty(o)&&n.searchParams.set(o,m[o]);return n.href}}b.default=j,(0,e.registerAction)("show-heartbeat",j)},function(a,b){(function(c){"use strict";Object.defineProperty(b,"__esModule",{value:!0});b.Action=class{constructor(g,h){this.normandy=g,this.recipe=h}};const e=b.registerAction=c&&c.registerAction||window&&window.registerAction||function(){},f=b.registerAsyncCallback=c&&c.registerAsyncCallback||window&&window.registerAsyncCallback||function(){}}).call(b,function(){return this}())}]);